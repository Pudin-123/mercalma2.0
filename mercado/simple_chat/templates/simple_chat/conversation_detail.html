{% extends 'base.html' %}

{% load static %}

{% block title %}Chat con {{ conversation.seller.username }} â€¢ MERCALMA{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        max-height: 60vh;
        overflow-y: auto;
        background: var(--muted, #f8f9fa);
        padding: 1rem;
    }

    .message {
        margin-bottom: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        max-width: 80%;
        background: var(--card-bg, #fff);
        box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    .message.mine {
        margin-left: auto;
        background: var(--primary-color, #007bff);
        color: white;
    }

    .message .content { word-break: break-word; }

    .emoji-large { font-size: 2.25rem; text-align:center; margin-bottom: .5rem }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h3>ðŸ’¬ Chat sobre: {{ conversation.product.title }}</h3>
            <p class="text-muted">
                {% if request.user == conversation.buyer %}
                    Vendedor: {{ conversation.seller.username }}
                {% else %}
                    Comprador: {{ conversation.buyer.username }}
                {% endif %}
            </p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ conversation.product.get_absolute_url }}" class="btn btn-outline-primary">Ver Producto</a>
            <a href="{% url 'simple_chat:conversation_list' %}" class="btn btn-outline-secondary">Volver</a>
        </div>
    </div>

    <div class="chat-container border rounded mb-3" id="chatMessages">
        {% for chat_message in chat_messages %}
            <div class="message {% if chat_message.sender == request.user %}mine{% endif %}" data-message-id="{{ chat_message.id }}">
                <div class="content">{{ chat_message.text }}</div>
                <small class="text-muted d-block mt-1">{{ chat_message.sender.username }} â€¢ {{ chat_message.created_at|date:"d/m/Y H:i" }}</small>
            </div>
        {% empty %}
            <p class="text-center text-muted">No hay mensajes aÃºn. Â¡SÃ© el primero en escribir!</p>
        {% endfor %}
    </div>

    <form method="post" id="messageForm" class="mt-3">
        {% csrf_token %}
        <div class="input-group">
            <input type="text" name="message" class="form-control" placeholder="Escribe tu mensaje..." required autocomplete="off">
            <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
    </form>

    <!-- Error toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-danger text-white">
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chatMessages');
    const messageForm = document.getElementById('messageForm');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    const currentUser = "{{ request.user.username|escapejs }}";

    // Scroll al final del chat
    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;

    function appendMessage(message) {
        const messageDiv = document.createElement('div');
        const isMine = message.sender === currentUser;
        messageDiv.className = 'message' + (isMine ? ' mine' : '');
        messageDiv.dataset.messageId = message.id;
        messageDiv.innerHTML = `
            <div class="content">${message.text}</div>
            <small class="text-muted d-block mt-1">${message.sender} â€¢ ${message.created_at}</small>
        `;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Manejar envÃ­o de mensajes via AJAX
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok' && data.message) {
                messageForm.reset();
                appendMessage(data.message);
            } else {
                throw new Error(data.message || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const toastEl = document.getElementById('errorToast');
            if (toastEl) {
                toastEl.querySelector('.toast-body').textContent = error.message || 'Error al enviar el mensaje.';
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            } else {
                alert('Error al enviar el mensaje. Por favor, intenta nuevamente.');
            }
        })
        .finally(() => { submitButton.disabled = false; });
    });

    // Actualizar chat periÃ³dicamente
    let lastMessageId = Number(chatContainer.querySelector('.message:last-child')?.dataset?.messageId || 0);

    function updateChat() {
        fetch(`${window.location.href}?after=${lastMessageId}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.json())
        .then(data => {
            if (Array.isArray(data.messages)) {
                data.messages.forEach(message => {
                    if (message.id > lastMessageId) {
                        appendMessage(message);
                        lastMessageId = message.id;
                    }
                });
            }
        })
        .catch(console.error);
    }

    // Actualizar cada 10 segundos
    setInterval(updateChat, 10000);
});
</script>
{% endblock %}