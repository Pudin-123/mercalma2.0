{% extends 'base.html' %}
{% block title %}Tu carrito{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4 fw-bold text-primary">üõí Tu Carrito</h2>

  {% if items %}
  <form method="post" action="{% url 'market:update_cart' %}">
    {% csrf_token %}
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle text-center">
            <thead class="table-light">
              <tr>
                <th style="width: 45%;">Producto</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Subtotal</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <td class="text-start">
                  <div class="d-flex align-items-center">
                    {% if item.product.image %}
                      <img src="{{ item.product.image.url }}" alt="{{ item.product.title }}"
                           class="img-thumbnail me-3" style="width: 80px; height: 80px; object-fit: cover;">
                    {% else %}
                      <div class="bg-light me-3 d-flex justify-content-center align-items-center rounded"
                           style="width: 80px; height: 80px;">
                        <span class="text-muted small">Sin imagen</span>
                      </div>
                    {% endif %}
                    <div>
                      <a href="{% url 'market:product_detail' item.product.id %}" class="text-decoration-none fw-semibold text-dark">
                        {{ item.product.title }}
                      </a><br>
                      {% if item.product.seller %}
                        <small class="text-muted">Vendedor: {{ item.product.seller.username }}</small>
                      {% endif %}
                    </div>
                  </div>
                </td>
                <td style="width:120px;">
                  <input 
                    type="number"
                    name="quantity_{{ item.product.id }}"
                    value="{{ item.quantity }}"
                    min="1"
                    class="form-control text-center"
                  >
                </td>
                <td>${{ item.product.price }}</td>
                <td>${{ item.total_price }}</td>
                <td>
                  <form method="post" action="{% url 'market:remove_from_cart' item.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm">Eliminar</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
      <h4>Total: <strong>${{ total_price }}</strong></h4>
      <div class="d-flex flex-wrap gap-2">
        <a href="{% url 'market:clear_cart' %}" class="btn btn-outline-secondary">Vaciar</a>
        <button type="submit" class="btn btn-outline-primary">Actualizar</button>
      </div>
    </div>
  </form>

  <div class="text-center mt-4 d-flex flex-wrap justify-content-center gap-2">
    <form method="post" action="{% url 'market:create_order' %}">
      {% csrf_token %}
      <input type="hidden" name="provider" value="stripe">
      <button class="btn btn-primary">üí≥ Pagar con Stripe</button>
    </form>

    <form method="post" action="{% url 'market:create_order' %}">
      {% csrf_token %}
      <input type="hidden" name="provider" value="mp">
      <a href="{% url 'market:mercadopago_checkout' %}" class="btn btn-outline-primary">
  üí∞ Pagar con Mercado Pago
  </a>
    </form>
  </div>

  {% else %}
  <div class="alert alert-info text-center shadow-sm mt-4">
    üõçÔ∏è Tu carrito est√° vac√≠o.<br>
    <a href="{% url 'market:product_list' %}" class="btn btn-outline-primary mt-2">Ver productos</a>
  </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const quantityInputs = document.querySelectorAll('input[name^="quantity_"]');
  const totalElement = document.querySelector("h4 strong");

  quantityInputs.forEach(input => {
    let timeoutId;

    input.addEventListener("change", function () {
      const quantity = parseInt(this.value);
      if (isNaN(quantity) || quantity < 1) {
        this.value = 1;
        return;
      }

      const productId = this.name.split("_")[1];
      if (timeoutId) clearTimeout(timeoutId);

      timeoutId = setTimeout(() => {
        fetch("{% url 'market:update_cart_ajax' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: `product_id=${productId}&quantity=${quantity}`,
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const row = this.closest("tr");
            const subtotalCell = row.querySelector("td:nth-child(4)");
            subtotalCell.textContent = `$${data.subtotal.toFixed(2)}`;
            totalElement.textContent = `$${data.total_price.toFixed(2)}`;
          } else {
            alert(data.error || "Error al actualizar el carrito");
            this.value = this.defaultValue;
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("Error en la conexi√≥n con el servidor");
          this.value = this.defaultValue;
        });
      }, 300);
    });

    input.defaultValue = input.value;
  });
});
</script>
{% endblock %}

